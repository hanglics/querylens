<!DOCTYPE html>
<!--suppress ALL -->
<html lang="en" xmlns:v-on="http://www.w3.org/1999/xhtml" xmlns:v-bind="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>searchrefiner - QueryVis</title>
    <link rel="icon" href="/static/favicon.png" type="image/x-png">
    <link rel="stylesheet" href="/static/spectre.min.css" type="text/css">
    <link rel="stylesheet" href="/static/spectre-icons.min.css" type="text/css">
    <link rel="stylesheet" href="/static/spectre-exp.min.css" type="text/css">
    <link rel="stylesheet" href="/static/vis.min.css" type="text/css">
    <link rel="stylesheet" href="/static/vue-multiselect.min.css" type="text/css">
    <link rel="stylesheet" href="/static/logtail.css" type="text/css">
    <link rel="stylesheet" href="/static/searchrefiner.css" type="text/css">
    <link rel="stylesheet" href="/static/jquery.highlight-within-textarea.css"/>
    <style>
        .main {
            padding-left: 20%;
            padding-right: 20%;
        }
    </style>
</head>
<body>

<div class="container" id="app">
    <header class="navbar bg-secondary nav-height">
        {{template "sidebar"}}
    </header>
    <h1 class="main">QueryLens</h1>
    <div class="main" v-if="!submitted">
        <textarea class="form-input" rows="15" placeholder="Enter query here." v-model:value="query"></textarea>
        <div class="form-group">
            <label>Query Language
                <small><a href="/help#WritingQueries">help?</a></small>
                <select class="form-select" v-bind:value="lang" v-model="lang">
                    <option value="pubmed">PubMed</option>
                    <option value="medline">Ovid MEDLINE</option>
                    <option disabled>Cochrane Library (Coming eventually)</option>
                    <option disabled>EMBASE (Coming eventually)</option>
                </select>
            </label>
        </div>
        <button class="btn btn-primary mt-2 float-right" v-on:click="submitNew">Submit</button>
    </div>
    <div class="main" v-if="submitted">
        <div v-if="queries.length == 0">
            <p>Your submitted query:</p>
            <textarea disabled class="form-input" rows="15" v-model:value="query"></textarea>
            <p>Please do not refresh or navigate away from this page.</p>
            <div v-if="progress == 0">
                <progress class="progress" min="0" max="100"></progress>
                <p>[[message]]</p>
                <i>This process will be faster the next time around. The results from your query will be cached.</i>
            </div>
            <div v-if="progress > 0">
                <progress class="progress" v-bind:value="progress" min="0" max="100"></progress>
                <p>Evaluating queries...</p>
            </div>
        </div>
        <div v-if="queries.length > 0">
            <div class="container">
                <div class="columns">
                    <div class="column col-6">
                        <button class="btn btn-primary mb-2" v-on:click="reset">Back</button>
                        <textarea disabled class="form-input" rows="15" v-model:value="queries[queryIdx].query"></textarea>
                        <input class="slider" type="range" min="0" v-bind:max="queries.length-1" v-model.number="queryIdx" v-bind:value="queryIdx">
                        <button class="btn btn-primary mt-2 float-right" v-on:click="submitNew">Submit</button>
                        <ul>
                            <li>F1: [[queries[queryIdx].f1]]</li>
                            <li>Precision: [[queries[queryIdx].precision]]</li>
                            <li>Recall: [[queries[queryIdx].recall]]</li>
                            <li># Retrieved: [[queries[queryIdx].num_ret]]</li>
                        </ul>
                    </div>
                    <div class="column col-6">
                        <canvas id="chart1" width="10" height="10"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="/static/vue.js" type="text/javascript"></script>
<script src="/static/lodash.min.js" type="text/javascript"></script>
<script src="/plugin/querylens/static/Chart.bundle.js" type="text/javascript"></script>
<script type="text/javascript">
    var vm = new Vue({
        el: "#app",
        delimiters: ["[[", "]]"],
        data: {
            ws: null,
            query: "(((esophag*[All Fields] OR oesophag*[All Fields]) AND (varic*[All Fields] OR varix*[All Fields])) OR (Esophageal[All Fields] AND Gastric Varices[All Fields]))",
            lang: "pubmed",
            status: "",
            queries: [],
            queryIdx: 0,
            progress: 0,
            submitted: false,
            chart: null,
            message: "spooky!",
        },
        methods: {
            reset: function () {
                this.ws.close();
            },
            submitNew: function () {
                let protocol = 'ws:';
                if (window.location.protocol === 'https:') {
                    protocol = 'wss:';
                }


                if (this.ws !== null) {
                    this.ws.close();
                }

                this.ws = new WebSocket(window.location.toString().replace(window.location.protocol, protocol) + "?lens=y");
                let self = this;
                this.ws.onopen = function () {
                    self.queries = [];
                    self.progress = 0;
                    self.queryIdx = 0;
                    self.ws.send(JSON.stringify({query: self.query, language: self.lang}));
                    self.submitted = true;
                    console.log("opened websocket");
                };
                this.ws.onmessage = function (evt) {
                    data = JSON.parse(evt.data)
                    switch (data.type) {
                        case "queries":
                            self.queries = data.queries;
                            self.renderCharts();
                        case "executing":
                            self.progress = data.progress;
                            self.message = "Evaluating queries..."
                        case "message":
                            self.message = data.message;
                    }
                }
                this.ws.onclose = function () {
                    self.queries = [];
                    self.progress = 0;
                    self.submitted = false;
                }
            },
            renderCharts: function () {
                var self = this;
                window.setTimeout(function () {
                    var ctx = document.getElementById('chart1').getContext('2d');
                    var points = [];
                    var labels = [];
                    var max = 0.0;
                    var min = 1.0;
                    for (var i = 0; i < self.queries.length; i++) {
                        points.push({
                            x: self.queries[i].precision,
                            y: self.queries[i].recall
                        });
                        labels.push(i.toString())
                    }
                    var chart = new Chart(ctx, {
                        type: 'scatter',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: "Variations",
                                pointRadius: function (ctx) {
                                    let index = ctx.dataIndex;
                                    if (self.queries[index].shape == "triangle" || self.queries[index].shape == "cross") {
                                        return 20;
                                    }
                                    return index === self.queryIdx ? 10 : 5;
                                },
                                pointStyle: function (ctx) {
                                    let index = ctx.dataIndex;
                                    return index === self.queryIdx ? "star" : self.queries[index].shape;
                                },
                                pointBorderWidth: function (ctx) {
                                    let index = ctx.dataIndex;
                                    return index === self.queryIdx ? 5 : 1;
                                },
                                backgroundColor: '#5755d9',
                                borderColor: '#5755d9',
                                data: points
                            }]
                        },
                        options: {
                            showTooltips: false,
                            onClick: function (evt) {
                                var els = chart.getElementsAtEvent(evt);
                                if (els.length > 0) {
                                    var el = els[0];
                                    self.queryIdx = el._index;
                                }
                            },
                            scales: {
                                xAxis: [{
                                    scaleLabel: {
                                        display: true,
                                        labelString: "Precision",
                                    }
                                }],
                                yAxis: [{
                                    scaleLabel: {
                                        display: true,
                                        labelString: "Recall",
                                    }
                                }]
                            }
                        }
                    });
                    self.chart = chart;
                }, 1000)
            }
        },
        watch: {
            queryIdx: _.debounce(function () {
                this.query = this.queries[this.queryIdx].query;
                this.chart.update();
            }, 50)
        }
    })
</script>

</body>
</html>